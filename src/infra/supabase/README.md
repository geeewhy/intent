# Supabase Integration

This directory contains the necessary files for integrating with Supabase, including authentication, database schema, and edge functions.

## Database Schema

The database schema is defined in the `sql` directory:

- `schema.sql`: Creates the necessary tables for authentication and data storage and RLS

### Tables

- `households`: Represents tenants in the system
- `profiles`: Maps users to households (tenants)
- `commands`: Stores commands sent by clients
- `events`: Stores events generated by the system
- `aggregates`: Stores the current state of aggregates

### Views

- `current_tenant`: Helper view for RLS that detects the current tenant from JWT claims

## Edge Functions

The edge functions are defined in the `edge-functions` directory:

- `command.ts`: Handles commands sent by clients
- `on-signup.ts`: Handles user signup, creates a profile, and assigns the user to a household

## Authentication

Authentication is handled by Supabase Auth. The system supports:

1. **Production Authentication**: Users are assigned to households (tenants) and their JWTs contain the household_id claim.
2. **Test Authentication**: For testing, you can create a fake JWT with a test_tenant_id claim.

### Test Authentication

For testing, you can use the `createTestClient` function from `src/client/auth/test-auth.ts`:

```typescript
import { createTestClient } from '../client/auth/test-auth';

// Create a client with a fake tenant ID
const supabase = await createTestClient('fake-tenant-id');
```

## Integration Tests

The integration tests are defined in the `src/test/integration` directory:

- `test-command.ts`: Tests the executeTest command and testExecuted event

To run the integration test:

```bash
npx ts-node src/test/integration/test-command.ts [tenant-id]
```

If no tenant ID is provided, a random UUID will be generated.

## Setup Instructions

1. Create the necessary tables and RLS policies in your Supabase project:
   - Run the SQL in `sql/schema.sql`
   - Run the SQL in `sql/rls.sql`

2. Deploy the edge functions to your Supabase project:
   - Deploy `edge-functions/command.ts` as a function named `command`
   - Deploy `edge-functions/on-signup.ts` as a function named `on-signup`

3. Set up environment variables:
   - `SUPABASE_URL`: Your Supabase project URL
   - `SUPABASE_ANON_KEY`: Your Supabase anonymous key
   - `SUPABASE_SERVICE_KEY`: Your Supabase service key (for admin operations)